<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Libro BIM - Instalaciones</title>
    <style>
        body { margin: 0; padding: 0; overflow: hidden; font-family: sans-serif; }
        #viewer-container { width: 100vw; height: 100vh; position: relative; background: #f0f0f0; }
        
        /* Panel Flotante */
        #ui-panel {
            position: absolute; top: 20px; left: 20px; width: 200px;
            background: rgba(255, 255, 255, 0.9); padding: 15px; 
            border-radius: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); z-index: 2;
        }
        .btn-filter {
            width: 100%; padding: 10px; margin-bottom: 5px; border: 1px solid #ccc;
            background: white; border-radius: 5px; cursor: pointer; font-weight: bold;
        }
        .btn-filter:hover { background: #eee; }
        .btn-filter.active { background: #333; color: white; border-color: #333; }
        
        /* Pantalla de Carga */
        #loading {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: white; display: flex; justify-content: center; align-items: center; z-index: 10;
            font-size: 1.2rem; color: #555;
        }
    </style>

    <!-- MAPA DE IMPORTACI√ìN: Esto soluciona el conflicto de versiones -->
    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.135.0/build/three.module.js",
                "web-ifc": "https://unpkg.com/web-ifc@0.0.36/web-ifc-api.js",
                "web-ifc-viewer": "https://unpkg.com/web-ifc-viewer@1.0.216/dist/web-ifc-viewer.js"
            }
        }
    </script>
</head>
<body>

    <div id="loading">Cargando modelo... por favor espera.</div>

    <div id="ui-panel">
        <h3>Filtros</h3>
        <button class="btn-filter active" onclick="resetModel(this)">üè† Ver Todo</button>
        <button class="btn-filter" onclick="filterCategory('CONDUIT', this)">‚ö° Tuber√≠as</button>
        <button class="btn-filter" onclick="filterCategory('BOXES', this)">üì¶ Cajas</button>
        <button class="btn-filter" onclick="filterCategory('DEVICES', this)">üí° Luces</button>
    </div>

    <div id="viewer-container"></div>

    <script type="module">
        import { IfcViewerAPI } from 'web-ifc-viewer';
        import { IFCFLOWSEGMENT, IFCFLOWFITTING, IFCCABLECARRIERSEGMENT, IFCCABLECARRIERFITTING, IFCFLOWCONTROLLER, IFCELECTRICDISTRIBUTIONPOINT, IFCLIGHTFIXTURE, IFCSENSOR, IFCOUTLET, IFCSWITCHINGDEVICE } from 'web-ifc';

        const container = document.getElementById('viewer-container');
        const viewer = new IfcViewerAPI({ container, backgroundColor: { r: 240, g: 240, b: 240, a: 1 } });

        // Configuraci√≥n del Visor
        viewer.axes.setAxes();
        viewer.grid.setGrid();

        let modelID = null;

        async function load() {
            // Configurar la ruta del decodificador WASM (esencial para que no de error)
            await viewer.IFC.setWasmPath('https://unpkg.com/web-ifc@0.0.36/', true);

            try {
                // URL ABSOLUTA DE TU ARCHIVO
                const url = 'https://almariozamudio-az.github.io/proyecto-casa-libro/modelo.ifc';
                
                const model = await viewer.IFC.loadIfcUrl(url);
                modelID = model.modelID;
                
                // Ocultar carga
                document.getElementById('loading').style.display = 'none';

            } catch (err) {
                console.error(err);
                document.getElementById('loading').innerText = 'Error: Revisa la consola (F12)';
            }
        }

        load();

        // --- L√ìGICA DE FILTRADO ---
        window.filterCategory = async (cat, btn) => {
            if (modelID === null) return;
            updateBtns(btn);

            let types = [];
            if (cat === 'CONDUIT') types = [IFCCABLECARRIERSEGMENT, IFCCABLECARRIERFITTING, IFCFLOWSEGMENT, IFCFLOWFITTING];
            if (cat === 'BOXES') types = [IFCFLOWCONTROLLER, IFCELECTRICDISTRIBUTIONPOINT];
            if (cat === 'DEVICES') types = [IFCLIGHTFIXTURE, IFCSENSOR, IFCOUTLET, IFCSWITCHINGDEVICE];

            // Buscar IDs
            let ids = [];
            for (const t of types) {
                const found = await viewer.IFC.getAllItemsOfType(modelID, t, false);
                ids.push(...found);
            }

            // Crear vista aislada
            viewer.IFC.loader.ifcManager.removeSubset(modelID, undefined, 'filter');
            const original = viewer.context.items.pickableIfcModels.find(m => m.modelID === modelID);
            if(original) original.visible = false;

            if(ids.length > 0) {
                viewer.IFC.loader.ifcManager.createSubset({
                    modelID: modelID, ids: ids, scene: viewer.context.getScene(), removePrevious: true, customId: 'filter'
                });
            }
        }

        window.resetModel = (btn) => {
            if (modelID === null) return;
            updateBtns(btn);
            viewer.IFC.loader.ifcManager.removeSubset(modelID, undefined, 'filter');
            const original = viewer.context.items.pickableIfcModels.find(m => m.modelID === modelID);
            if(original) original.visible = true;
        }

        function updateBtns(btn) {
            document.querySelectorAll('.btn-filter').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
        }

        // Eventos b√°sicos
        window.onmousemove = () => viewer.IFC.selector.prepickIfcItem();
        window.ondblclick = () => viewer.IFC.selector.pickIfcItem();

    </script>
</body>
</html>
