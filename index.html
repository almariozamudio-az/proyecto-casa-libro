<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Modelo Interactivo - Libro BIM</title>
    <style>
        /* --- ESTILOS (DISE√ëO) --- */
        body { margin: 0; padding: 0; overflow: hidden; font-family: 'Segoe UI', sans-serif; }
        
        /* Contenedor 3D */
        #viewer-container { 
            width: 100vw; 
            height: 100vh; 
            position: relative; 
            background: linear-gradient(to bottom, #ffffff, #e0e0e0); 
        }

        /* Panel de Control Flotante */
        #ui-panel {
            position: absolute; 
            top: 20px; 
            left: 20px;
            width: 240px;
            background: rgba(255, 255, 255, 0.95);
            padding: 20px; 
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
            z-index: 2;
            backdrop-filter: blur(8px);
            border: 1px solid rgba(0,0,0,0.05);
        }

        h1 { margin: 0 0 5px 0; font-size: 18px; color: #222; font-weight: 700; }
        p { margin: 0 0 15px 0; font-size: 12px; color: #666; }

        /* Botones */
        .btn-filter {
            display: flex;
            align-items: center;
            width: 100%; 
            padding: 12px; 
            margin-bottom: 8px;
            border: 1px solid #eee; 
            background: #fff; 
            border-radius: 10px;
            cursor: pointer; 
            transition: all 0.2s ease;
            font-size: 14px;
            font-weight: 600;
            color: #444;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .btn-filter:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .btn-filter:active { transform: scale(0.98); }
        
        /* Estilo del bot√≥n activo */
        .btn-filter.active { 
            background: #2c3e50; 
            color: white; 
            border-color: #2c3e50; 
        }

        /* Iconos en los botones */
        .icon { margin-right: 10px; font-size: 18px; }

        /* Pantalla de Carga */
        #loading {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: white; display: flex; flex-direction: column;
            justify-content: center; align-items: center; z-index: 10;
            transition: opacity 0.5s;
        }
        .spinner {
            width: 40px; height: 40px; border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db; border-radius: 50%;
            animation: spin 1s linear infinite; margin-bottom: 15px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Ajuste para m√≥viles */
        @media (max-width: 600px) {
            #ui-panel {
                top: auto; bottom: 20px; left: 20px; right: 20px; width: auto;
                padding: 15px;
            }
            h1 { font-size: 16px; }
        }
    </style>
</head>
<body>

    <!-- Pantalla de Carga -->
    <div id="loading">
        <div class="spinner"></div>
        <div id="loading-text">Cargando modelo BIM...</div>
    </div>

    <!-- Interfaz de Usuario -->
    <div id="ui-panel">
        <h1>Instalaciones El√©ctricas</h1>
        <p>Selecciona un sistema para aislarlo:</p>
        
        <button class="btn-filter active" onclick="resetModel(this)">
            <span class="icon">üè†</span> Ver Todo
        </button>
        
        <!-- Bot√≥n para Tubos (Conduits) -->
        <button class="btn-filter" onclick="filterCategory('CONDUIT', this)">
            <span class="icon">‚ö°</span> Tuber√≠as (EMT/PVC)
        </button>
        
        <!-- Bot√≥n para Cajas y Tableros -->
        <button class="btn-filter" onclick="filterCategory('BOXES', this)">
            <span class="icon">üì¶</span> Cajas y Tableros
        </button>
        
        <!-- Bot√≥n para Sensores y Luces -->
        <button class="btn-filter" onclick="filterCategory('DEVICES', this)">
            <span class="icon">üí°</span> Iluminaci√≥n y Tomas
        </button>
    </div>

    <!-- Lienzo 3D -->
    <div id="viewer-container"></div>

    <!-- --- L√ìGICA (JAVASCRIPT) --- -->
    <script type="module">
        // Importamos la librer√≠a del visor (Viewer) y las constantes IFC (tipos de objetos)
        import { IfcViewerAPI } from 'https://esm.sh/web-ifc-viewer@1.0.217';
        import { 
            IFCFLOWSEGMENT, IFCFLOWFITTING, IFCCABLECARRIERSEGMENT, IFCCABLECARRIERFITTING, // Tubos y curvas
            IFCFLOWCONTROLLER, IFCELECTRICDISTRIBUTIONPOINT, // Cajas y tableros
            IFCLIGHTFIXTURE, IFCSENSOR, IFCOUTLET, IFCSWITCHINGDEVICE // Luces y sensores
        } from 'https://esm.sh/web-ifc';

        const container = document.getElementById('viewer-container');
        const viewer = new IfcViewerAPI({ container, backgroundColor: { r: 255, g: 255, b: 255, a: 0 } });

        let modelID = null;

        // Iniciar Visor
        async function init() {
            // Configurar motor WASM (el cerebro)
            await viewer.IFC.setWasmPath('https://unpkg.com/web-ifc@0.0.36/');

            // Configuraci√≥n visual
            viewer.axes.setAxes(); // Ejes X,Y,Z
            viewer.grid.setGrid(); // Rejilla de suelo
            
            // Intentar cargar el modelo
            try {
                // CARGA EL ARCHIVO: Aseg√∫rate que se llame 'modelo.ifc'
                const model = await viewer.IFC.loadIfcUrl('https://almariozamudio-az.github.io/proyecto-casa-libro/modelo.ifc');
                modelID = model.modelID;
                
                // Ocultar pantalla de carga
                const loadingScreen = document.getElementById('loading');
                loadingScreen.style.opacity = '0';
                setTimeout(() => loadingScreen.style.display = 'none', 500);

            } catch (error) {
                console.error("Error cargando el IFC:", error);
                document.getElementById('loading-text').innerText = "Error: No se encuentra 'modelo.ifc'";
            }
        }

        init();

        // --- FUNCI√ìN MAESTRA DE FILTRADO ---
        window.filterCategory = async (category, btnElement) => {
            if (modelID === null) return;

            updateActiveButton(btnElement);

            // 1. Definir qu√© estamos buscando seg√∫n el bot√≥n presionado
            let categoriesToSearch = [];

            if (category === 'CONDUIT') {
                // Revit suele usar CableCarrier para el√©ctricos y FlowSegment para hidrosanitarios
                categoriesToSearch = [IFCCABLECARRIERSEGMENT, IFCCABLECARRIERFITTING, IFCFLOWSEGMENT, IFCFLOWFITTING];
            } else if (category === 'BOXES') {
                categoriesToSearch = [IFCFLOWCONTROLLER, IFCELECTRICDISTRIBUTIONPOINT];
            } else if (category === 'DEVICES') {
                categoriesToSearch = [IFCLIGHTFIXTURE, IFCSENSOR, IFCOUTLET, IFCSWITCHINGDEVICE];
            }

            // 2. Buscar todos los IDs en el modelo
            const ids = [];
            for (const type of categoriesToSearch) {
                const found = await viewer.IFC.getAllItemsOfType(modelID, type, false);
                ids.push(...found);
            }

            // 3. Crear el "Subset" (La vista filtrada)
            // Primero borramos cualquier filtro anterior
            viewer.IFC.loader.ifcManager.removeSubset(modelID, undefined, 'custom-filter');
            
            // Ocultamos el modelo original completo
            const originalModel = viewer.context.items.pickableIfcModels.find(m => m.modelID === modelID);
            if(originalModel) originalModel.visible = false;

            // Creamos el nuevo sub-modelo solo con lo seleccionado
            if (ids.length > 0) {
                viewer.IFC.loader.ifcManager.createSubset({
                    modelID: modelID,
                    ids: ids,
                    scene: viewer.context.getScene(),
                    removePrevious: true,
                    customId: 'custom-filter'
                });
            } else {
                alert("No se encontraron elementos de esta categor√≠a en este archivo IFC.");
            }
        }

        // --- FUNCI√ìN PARA RESTAURAR TODO ---
        window.resetModel = (btnElement) => {
            if (modelID === null) return;
            updateActiveButton(btnElement);

            // Borrar el filtro personalizado
            viewer.IFC.loader.ifcManager.removeSubset(modelID, undefined, 'custom-filter');

            // Mostrar el modelo original
            const originalModel = viewer.context.items.pickableIfcModels.find(m => m.modelID === modelID);
            if(originalModel) originalModel.visible = true;
        }

        // Funci√≥n auxiliar para cambiar el color del bot√≥n
        function updateActiveButton(clickedBtn) {
            // Quitar clase 'active' a todos
            document.querySelectorAll('.btn-filter').forEach(b => b.classList.remove('active'));
            // Poner clase 'active' al clickeado
            clickedBtn.classList.add('active');
        }

        // Habilitar interacci√≥n (hover)
        window.onmousemove = () => viewer.IFC.selector.prepickIfcItem();
        
        // Ajustar tama√±o si cambian la ventana
        window.addEventListener("resize", () => {
            viewer.context.updateCamera();
            viewer.context.renderer.setSize(window.innerWidth, window.innerHeight);
        });

    </script>
</body>
</html>
